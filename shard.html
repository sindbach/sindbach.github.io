<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="javascripts/rangeslider.css">

    <!-- Google fonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="javascripts/rangeslider.min.js"></script>
    <style>
        .legend {
            font-family: 'Raleway', sans-serif;
            fill: #333333;
        }
        .tooltip {
            fill: #333333;
        }
    </style>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>MongoDB: Shard existing collection</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">
        <header>
          <h1>MongoDB: Shard existing collection</h1>
          <h2>Calculator</h2>
        </header>
        <section id="main_content">
            <div align="right">
            <h4>MongoDB version: </h4><label>
                <select width="70" style="width: 70px" id="selectversion">
                    <option selected> 3.3 </option>
                    <option> 3.2 </option>
                </select>
            </label>
            </div>
            <div id="js-numshards-update-value">
            <h3>Total number of shards</h3>
            <input type="range" min="1" max="50" value="4" id="slider_num_shards" data-rangeslider> 
            <output></output> 
            <input type="number" value="4" id="box_num_shards">
            <hr>
            </div>

            <div id="js-shardkey-update-value">
            <h3>Shard Key Size </h3>
            <h4>Size in Bytes </h4>
            <input type="range" min="8" max="512" value="100" id="slider_shard_key" data-rangeslider> 
            <output></output> 
            <input type="number" value="100" id="box_shard_key">
            </div><hr>

            <div id="js-chunksize-update-value">
            <h3>Chunk Size </h3>
            <h4>Size in MBytes</h4>
            <input type="range" min="16" max="1000" step="2" value="64" id="slider_chunk_size" data-rangeslider> 
            <output></output> 
            <input type="number" value="64" id="box_chunk_size">
            </div><hr>

            <div id="js-maxcoll-update-value">
            <h3>Maximum (Existing) Collection Size </h3>
            <h4>Size in GBytes</h4>
            <input type="range" min="1" max="16384" value="1049" id="slider_max_coll" data-rangeslider> 
            <output></output> 
            <input type="number" value="1049" id="box_max_coll">
            </div><hr>

            <div>The chart below represents the functional relationships between the factors above: </div>
            <div id="radarChart" class="radarChart"></div>
            </br><hr>
            <div>
                <h3>Calculation formula: </h3>
                <h4>Split Points = Maximum BSON Document Size / Shard Key Size </h4>
                <h4>Max Splits = MIN(1000000, 8192 * Number of Shards, Split Points)</h4> 
                <h4>Maximum (Existing) Collection Size = Max Splits * Chunk Size / 2 </h4>
            </div>

            <script src="javascripts/radarChart.js"></script>   
            <script>
                var LIMIT_A = 8192;
                var LIMIT_B = 1000000;
                var MEGA = 1000000;
                var GIGA = 1000000000;
                var DOC_SIZE = 16 * MEGA;
                var KEY_SHARDKEY = "ShardKey Bytes";
                var KEY_CHUNKSIZE = "ChunkSize MBytes";
                var KEY_MAXCOLL = "CollectionSize GBytes";
                var KEY_NUMSHARDS = "Number of Shards";
                var V32 = "3.2";
                var V33 = "3.3";
                ////////////////////////////////////////////////////////////// 
                //////////////////////// Set-Up ////////////////////////////// 
                ////////////////////////////////////////////////////////////// 

                var margin = {top: 100, right: 100, bottom: 100, left: 100},
                    width = Math.min(700, window.innerWidth - 10) - margin.left - margin.right,
                    height = Math.min(width, window.innerHeight - margin.top - margin.bottom - 20);
                        
                ////////////////////////////////////////////////////////////// 
                ////////////////////////// Data ////////////////////////////// 
                ////////////////////////////////////////////////////////////// 
                var data = [];

                if ($('#selectversion').val() == V32) {
                        data.push([
                              {axis:KEY_MAXCOLL, value: 16},
                              {axis:KEY_CHUNKSIZE, value: 960},
                              {axis:KEY_SHARDKEY, value: 3000}                            
                              ]);
                }else{
                        data.push([
                              {axis:KEY_MAXCOLL, value: 16},
                              {axis:KEY_CHUNKSIZE, value: 960},
                              {axis:KEY_SHARDKEY, value: 3000}, 
                              {axis:KEY_NUMSHARDS, value: 400}
                            ]);
                }
                ////////////////////////////////////////////////////////////// 
                //////////////////// Draw the Chart ////////////////////////// 
                ////////////////////////////////////////////////////////////// 
                var color = d3.scale.ordinal()
                    .range(["#CC333F","#EDC951","#00A0B0"]);
                    
                var radarChartOptions = {
                  w: width,
                  h: height,
                  margin: margin,
                  maxValue: 0.5,
                  levels: 10,
                  roundStrokes: true,
                  color: color
                };
                //Call function to draw the Radar chart
                RadarChart("#radarChart", data, radarChartOptions);

                ////////////////////////////////////////////////////////////// 
                //////////////////// Connect Components //////////////////////
                ////////////////////////////////////////////////////////////// 
                function updateSliderAndBox(name, value){
                    var box_name = "#box_" + name; 
                    var slider_name = "#slider_" + name;
                    $(box_name).val(value);
                    $(slider_name).val(value);
                }
                function maximumNumberOfChunks(shard_key, num_shards, version){
                    var numChunks = Math.round(DOC_SIZE/shard_key);
                    if (version == V32) {
                        limit = Math.min(LIMIT_B, numChunks);
                    }else{
                        limit = Math.min(LIMIT_A * num_shards, LIMIT_B, numChunks);
                    }
                    console.log("maximum limit min: " + limit);
                    return limit;
                }
                function calculateMaxCollection(shard_key, chunk_size, num_shards, version){
                    var new_max_coll = maximumNumberOfChunks(shard_key, num_shards, version) * chunk_size * MEGA / 2 ;
                    return Math.round(new_max_coll/GIGA);
                }
                function calculateChunkSize(shard_key, max_coll, num_shards, version){
                    var new_chunk_size = Math.round(2 * max_coll * GIGA / maximumNumberOfChunks(shard_key, num_shards, version));
                    return Math.round(new_chunk_size/MEGA);
                }
                function updateChart(shard_key, chunk_size, max_coll, num_shards, version){
                    var data = [];
                    if (version == V32){
                        data.push([
                                {axis:KEY_MAXCOLL, value: max_coll },
                                {axis:KEY_CHUNKSIZE, value: chunk_size * 15},
                                {axis:KEY_SHARDKEY, value: shard_key * 30 },
                           ]);
                    }
                    else{
                        data.push([
                                {axis:KEY_MAXCOLL, value: max_coll },
                                {axis:KEY_CHUNKSIZE, value: chunk_size * 15},
                                {axis:KEY_SHARDKEY, value: shard_key * 30 },
                                {axis:KEY_NUMSHARDS, value: num_shards * 100}
                           ]);
                    }
                    RadarChart("#radarChart", data, radarChartOptions);                    
                }
                function changeMaxCollection(shard_key, chunk_size, num_shards, version){
                    var new_max_coll = calculateMaxCollection(shard_key, chunk_size, num_shards, version);
                    updateSliderAndBox("max_coll", new_max_coll);  
                }
                function changeChunkSize(shard_key, max_coll, num_shards, version){
                    var new_chunk_size = calculateChunkSize(shard_key, max_coll, num_shards, version);
                    updateSliderAndBox("chunk_size", new_chunk_size);
                }
                /* Toggle MongoDB version */
                $('#selectversion').change(function(){
                    if ($('#selectversion').val() == V32) {
                        $('#js-numshards-update-value').hide();
                    }else{
                        $('#js-numshards-update-value').show();
                    }
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val(), 
                                $('#box_num_shards').val(), 
                                $('#selectversion').val());
                });
                /* Update input boxes when sliders changes */
                $('#slider_num_shards').on('input', function() { 
                    $('#box_num_shards').val($('#slider_num_shards').val()); 
                    changeMaxCollection($('#box_shard_key').val(), 
                                        $('#box_chunk_size').val(), 
                                        $('#box_num_shards').val(), 
                                        $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val(), 
                                $('#box_num_shards').val(), 
                                $('#selectversion').val());
                });
                $('#slider_shard_key').on('input', function() { 
                    $('#box_shard_key').val($('#slider_shard_key').val()); 
                    changeMaxCollection($('#box_shard_key').val(), 
                                        $('#box_chunk_size').val(), 
                                        $('#box_num_shards').val(), 
                                        $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val(), 
                                $('#box_num_shards').val(), 
                                $('#selectversion').val());
                });
                $('#slider_chunk_size').on('input', function() { 
                    $('#box_chunk_size').val($('#slider_chunk_size').val()); 
                    changeMaxCollection($('#box_shard_key').val(), 
                                        $('#box_chunk_size').val(), 
                                        $('#box_num_shards').val(), 
                                        $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val(), 
                                $('#box_num_shards').val(), 
                                $('#selectversion').val());
                });
                $('#slider_max_coll').on('input', function() { 
                    $('#box_max_coll').val($('#slider_max_coll').val()); 
                    changeChunkSize($('#box_shard_key').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                });

                /* Update sliders when input boxes changes */
                $('#box_num_shards').on('input', function() { 
                    $('#slider_num_shards').val($('#box_num_shards').val()); 
                    changeMaxCollection($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_num_shards').val(), $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                });
                $('#box_shard_key').on('input', function() { 
                    $('#slider_shard_key').val($('#box_shard_key').val()); 
                    changeMaxCollection($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_num_shards').val(), $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                });
                $('#box_chunk_size').on('input', function() { 
                    $('#slider_chunk_size').val($('#box_chunk_size').val());
                    changeMaxCollection($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_num_shards').val(), $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                });
                $('#box_max_coll').on('input', function() { 
                    $('#slider_max_coll').val($('#boxmax_coll').val()); 
                    changeChunkSize($('#box_shard_key').val(), $('#box_max_coll').val(), $('#box_num_shards').val(), $('#selectversion').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val(), $('#box_num_shards').val(),$('#selectversion').val());
                });
            </script>
        </section>
        <footer>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>
        </footer>
        <script>
        </script>
      </div>
    </div>
  </body>
</html>
