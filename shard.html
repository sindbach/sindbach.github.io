<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="stylesheets/rangeslider.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/vizuly_radial_progress.css">

    <!-- D3.js -->
    <script src="javascripts/d3.min.js" charset="utf-8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="javascripts/rangeslider.min.js"></script>
    <script src="javascripts/vizuly_core.min.js"></script>
    <script src="javascripts/vizuly_radialprogress.min.js"></script>
    <script> 
        var LIMIT_A = 8192;
        var LIMIT_B = 1000000;
        var MEGA = 1000000;
        var GIGA = 1000000000;
        var DOC_SIZE = 16 * MEGA;
        var SCALE_MAXCOLL = 1;
        var SCALE_CHUNKSIZE = 15;
        var SCALE_SHARDKEY = 30;
        var VIZ_MAXCOLL, VIZ_SHARDKEY, VIZ_CHUNKSIZE;
        $(function() {
            $('[data-rangeslider]').rangeslider({
                polyfill: false
            }); 
        });

    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>MongoDB: Shard existing collection</title>

  </head>

  <body>
    <div id="container">
      <div class="inner">
        <header>
          <h1>MongoDB: Shard existing collection</h1>
          <h2>Estimator</h2>
          Enter in the size of the intended shard-key and existing un-sharded collection to find out supported the chunk size to configure. If the resulting chunk size value is less than the default (64MB) there is no need to lower the chunk size value. 
        </header>
        <section id="main_content">

            <div id="js-shardkey-update-value" style="margin:0px auto; width:100%; height:200px;">
            <div class="left_slide" style="float:left; width:70%">
            <h3>Shard Key Size </h3>
            <h4>Size in Bytes </h4>
             <br>
            <input type="range" min="8" max="512" value="200" id="slider_shard_key" data-rangeslider> 
             <br>
            <input type="number" value="200" id="box_shard_key" min="1" max="512" >
            </div>
            <div id="radial_shard_key" class="right_radial_container" style="float:right"></div>
            </div><hr>

            <div id="js-maxcoll-update-value" style="margin:0px auto; width:100%; height:200px;">
            <div class="left_slide" style="float:left; width:70%">
            <h3>Maximum (Existing) Collection Size </h3>
            <h4>Size in GBytes</h4>
            <br>
            <input type="range"  min="1" max="500000" value="2560" id="slider_max_coll" data-rangeslider> 
            <br>
            <input type="number" value="2560" id="box_max_coll" min="1" max="500000">
            </div>
            <div id="radial_max_coll" class="right_radial_container" style="float:right"></div>
            </div>
            <hr>

            <div id="js-chunksize-update-value" style="margin:0px auto; width:100%; height:200px;">
            <div class="left_slide" style="float:left; width:70%">
            <h3>Chunk Size </h3>
            <h4>Size in MBytes</h4> 
             <br>
            <input type="range" min="16" max="1000" step="2" value="64" id="slider_chunk_size" data-rangeslider> 
            <br>
            <input type="number" value="64" id="box_chunk_size" min="1" max="1000">
            </div>
            <div id="radial_chunk_size" class="right_radial_container" style="float:right"></div>
            </div><hr>
            <div>
                <h3>To calculate shard key size:  </h3>
                <h4>Object.bsonsize( { k1:'value', k2:'value' } )</h4>
            </div><br>
            <div>
                <h3>Estimation formula: </h3>
                <h4>Split Points = Maximum BSON Document Size / Shard Key Size </h4>
                <h4>Max Splits = MIN(1000000, Split Points)</h4> 
                <h4>Maximum (Existing) Collection Size = Max Splits * Chunk Size / 2 </h4>
            </div>
            <script>

                ////////////////////////////////////////////////////////////// 
                //////////////////////// Functions /////////////////////////// 
                ////////////////////////////////////////////////////////////// 
                function updateSliderAndBox(name, value){
                    var box_name = "#box_" + name; 
                    var slider_name = "#slider_" + name;
                    $(box_name).val(value);
                    $(slider_name).val(value);
                    $(slider_name).rangeslider('update', true);
                }
                function maximumNumberOfChunks(shard_key){
                    var numChunks = Math.round(DOC_SIZE/shard_key);
                    limit = Math.min(LIMIT_B, numChunks);
                    return limit;
                }
                function calculateMaxCollection(shard_key, chunk_size){
                    var new_max_coll = maximumNumberOfChunks(shard_key) * chunk_size * MEGA / 2 ;
                    return Math.round(new_max_coll/GIGA);
                }
                function calculateChunkSize(shard_key, max_coll){
                    var new_chunk_size = Math.round(2 * max_coll * GIGA / maximumNumberOfChunks(shard_key));
                    return Math.min(1000, Math.round(new_chunk_size/MEGA));
                }
                function updateChart(shard_key, chunk_size, max_coll){
                    VIZ_MAXCOLL.data(max_coll/1000).update();
                    VIZ_SHARDKEY.data(shard_key).update();
                    VIZ_CHUNKSIZE.data(chunk_size).update(); 
                }
                function changeMaxCollection(shard_key, chunk_size){
                    var new_max_coll = calculateMaxCollection(shard_key, chunk_size);
                    updateSliderAndBox("max_coll", new_max_coll); 
                }
                function changeChunkSize(shard_key, max_coll){
                    var new_chunk_size = calculateChunkSize(shard_key, max_coll);
                    updateSliderAndBox("chunk_size", new_chunk_size);
                }

                ////////////////////////////////////////////////////////////// 
                //////////////////// Draw the Chart ////////////////////////// 
                ////////////////////////////////////////////////////////////// 
                var div1,div2,div3,divs;
                div1 = d3.select("#radial_max_coll");
                div2 = d3.select("#radial_shard_key");
                div3 = d3.select("#radial_chunk_size");
                divs=[div1,div2,div3];

                VIZ_MAXCOLL = vizuly.component.radial_progress(document.getElementById("radial_max_coll"));
                VIZ_SHARDKEY = vizuly.component.radial_progress(document.getElementById("radial_shard_key"));
                VIZ_CHUNKSIZE = vizuly.component.radial_progress(document.getElementById("radial_chunk_size"));
                vizs=[VIZ_MAXCOLL,VIZ_SHARDKEY,VIZ_CHUNKSIZE];

                // Apply radial theme
                vizs.forEach(function(viz, i){
                    vizuly.theme.radial_progress(viz).skin(vizuly.skin.RADIAL_PROGRESS_NEON);
                    viz.startAngle(180)                        
                       .endAngle(180)                         
                       .arcThickness(.12)    
                       .capRadius(1)    
                       .label(function (d,i) {                
                            return d3.format(".2f")(d);
                        });    
                });

                VIZ_MAXCOLL.min(0).max(250).label(function(d,i){return d3.format("0.3f")(d)+" TB"});
                VIZ_SHARDKEY.min(0).max(256).label(function(d,i){return d3.format("0f")(d)+" B"});
                VIZ_CHUNKSIZE.min(0).max(500).label(function(d,i){return d3.format("0f")(d)+" MB"});

                var s = String("800,200").split(",");
                var divWidth = s[0] * 0.80 / 3;
                divs.forEach(function (div,i) {
                    div.style("width",divWidth + 'px').style("margin-left", (s[0] *.05) + "px");
                    vizs[i].width(divWidth).height(divWidth).radius(divWidth/2.2);
                });
                VIZ_MAXCOLL.data(2560).update();
                VIZ_SHARDKEY.data(200).update();
                VIZ_CHUNKSIZE.data(64).update(); 
                updateChart($('#box_shard_key').val(), 
                            $('#box_chunk_size').val(), 
                            $('#box_max_coll').val());  

                ////////////////////////////////////////////////////////////// 
                //////////////////// Connect Components //////////////////////
                /* Update input boxes when sliders changes */
                $('#slider_shard_key').on('input', function() { 
                    $('#box_shard_key').val($('#slider_shard_key').val()); 
                    changeMaxCollection($('#box_shard_key').val(), 
                                        $('#box_chunk_size').val());
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val());
                });
                $('#slider_chunk_size').on('input', function() { 
                    $('#box_chunk_size').val($('#slider_chunk_size').val()); 
                    changeMaxCollection($('#box_shard_key').val(), 
                                        $('#box_chunk_size').val());
                    updateChart($('#box_shard_key').val(), 
                                $('#box_chunk_size').val(), 
                                $('#box_max_coll').val());
                });
                $('#slider_max_coll').on('input', function() { 
                    $('#box_max_coll').val($('#slider_max_coll').val()); 
                    changeChunkSize($('#box_shard_key').val(), $('#box_max_coll').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val());
                });

                /* Update sliders when input boxes changes */
                $('#box_shard_key').on('input', function() { 
                    $('#slider_shard_key').val($('#box_shard_key').val()).rangeslider('update', true); 
                    changeMaxCollection($('#box_shard_key').val(), $('#box_chunk_size').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val());
                });
                $('#box_chunk_size').on('input', function() { 
                    $('#slider_chunk_size').val($('#box_chunk_size').val()).rangeslider('update', true);
                    changeMaxCollection($('#box_shard_key').val(), $('#box_chunk_size').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val());
                });
                $('#box_max_coll').on('input', function() { 
                    $('#slider_max_coll').val($('#box_max_coll').val()).rangeslider('update', true); 
                    changeChunkSize($('#box_shard_key').val(), $('#box_max_coll').val());
                    updateChart($('#box_shard_key').val(), $('#box_chunk_size').val(), $('#box_max_coll').val());
                });

            </script>
        </section>
        <footer>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>
        </footer>
        <script>
        </script>
      </div>
    </div>
  </body>
</html>
